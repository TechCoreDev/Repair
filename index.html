<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pamko ‚Ä¢ Estimation R√©paration</title>
  <meta name="description" content="Estimez le prix de votre r√©paration en quelques secondes : choisissez la marque, le mod√®le et les probl√®mes rencontr√©s, obtenez un prix indicatif." />
  <style>
    :root{
      --bg1:#0b0b10; --bg2:#10131a; --bg3:#151a23; --muted:#aeb4c2; --text:#f7f8fa;
      --ring:rgba(255,255,255,.18); --radius:16px; --radius-lg:20px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --panel:rgba(255,255,255,.04); --panel-bd:rgba(255,255,255,.12);
      --menu-bg:#10141e; --menu-bd:rgba(255,255,255,.14); --menu-hover:rgba(255,255,255,.09);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2) 40%,var(--bg3));
    }
    a{color:inherit;text-decoration:none}

    .container{max-width:1100px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:center;gap:16px;text-align:center}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-badge{height:44px;width:44px;border-radius:14px;background:rgba(255,255,255,.08);display:grid;place-items:center;box-shadow:var(--shadow)}
    .brand h1{margin:0;font-size:22px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}

    .btn{appearance:none;border:0;background:#fff;color:#0b0b10;padding:10px 14px;border-radius:12px;font-weight:600;box-shadow:var(--shadow);cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-outline{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.15)}

    .progress{margin-top:18px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .progress div{height:8px;border-radius:999px;background:rgba(255,255,255,.18)}
    .progress .active{background:#fff}

    .card{margin-top:18px;background:var(--panel);border:1px solid var(--panel-bd);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow);backdrop-filter: blur(6px)}
    h2{margin:0;font-size:20px}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:14px}

    .grid{display:grid;gap:12px}
    @media(min-width:900px){
      .grid-3{grid-template-columns:1fr 2fr}
      .grid-4{grid-template-columns:repeat(4,1fr)}
      .grid-estimation{grid-template-columns:2fr 1fr}
    }

    label{display:block;font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.7)}
    select,input[type="text"]{width:100%;margin-top:8px;background:rgba(15,17,23,.6);color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px 14px;outline:none}
    select:focus,input[type="text"]:focus{box-shadow:0 0 0 3px var(--ring)}

    .model-list{margin-top:10px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-height:190px;overflow:auto}
    @media(min-width:900px){.model-list{grid-template-columns:repeat(3,1fr)}}
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(12,14,20,.55);padding:12px 12px;border-radius:12px;text-align:left;cursor:pointer;color:#fff}
    .chip.active{background:#fff;color:#0b0b10;border-color:#fff}
    .muted{color:var(--muted);font-size:14px}

    .issue{position:relative;border:1px solid rgba(255,255,255,.12);background:rgba(12,14,20,.55);padding:16px;border-radius:16px;text-align:left;cursor:pointer;color:#fff}
    .issue.active{background:#fff;color:#0b0b10;border-color:#fff}
    .issue svg{display:block;height:22px;width:22px;margin-bottom:8px}
    .issue small{opacity:.75}
    .tick{position:absolute;top:8px;right:10px;display:none}
    .issue.active .tick{display:inline}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .resume-list{list-style:none;padding:0;margin:12px 0 0;display:grid;gap:8px}
    .resume-item{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.06);padding:10px 12px;border-radius:12px}
    .total{margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.14)}
    .note{margin-top:10px;font-size:12px;color:var(--muted)}

    .side-card{
      background: linear-gradient(180deg,#ffffff 0%, #f6f8fc 100%);
      color:#0b0b10; border-radius:16px; padding:20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .side-card h3{ margin:0 0 12px 0; font-size:20px }
    .cta{
      width:100%; display:flex; align-items:center; justify-content:center; gap:10px;
      border:1px solid rgba(0,0,0,.06); background:#fff; border-radius:14px; padding:14px 16px;
      font-weight:700; cursor:pointer; transition:transform .06s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }
    .cta-primary{ background: linear-gradient(180deg,#2f6fff,#1f57f7); color:#fff; border:0; }
    .cta-ghost{ background:#f4f6fb; }
    .cta-whatsapp{ background: linear-gradient(180deg,#25D366,#1EBE59); color:#fff; border:0; }

    .preview{margin-top:12px; display:grid; grid-template-columns: 96px 1fr; gap:12px; align-items:center}
    .preview img{width:100%;height:100%;object-fit:cover;border-radius:12px}

    /* ====== Context menu (hover + clic) ====== */
    .menus{margin-top:12px; display:flex; flex-wrap:wrap; gap:10px}
    .menu-trigger{
      position:relative;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px;
      padding:10px 12px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; user-select:none;
      color:#fff;
    }
    .menu-trigger .chev{opacity:.8}
    .menu{
      position:absolute; top:calc(100% + 8px); left:0; z-index:50;
      min-width:260px;
      background:var(--menu-bg);
      border:1px solid var(--menu-bd);
      border-radius:12px; box-shadow:var(--shadow);
      padding:6px; display:none;
    }
    .menu.open{display:block}
    .menu-trigger:hover .menu{display:block}
    .menu .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    .menu .item:hover{ background:var(--menu-hover); }
    .menu .price{opacity:.9}
    .badge{font-size:11px; padding:3px 8px; border-radius:999px; background:rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.79 13.06a8 8 0 0 1-10.85 8.94 8 8 0 0 1-4.21-12.89l3.06 3.06a2 2 0 0 0 2.83 0l1.41-1.41a2 2 0 0 0 0-2.83L10.55 3.8A8 8 0 0 1 21.79 13.06z"/>
          </svg>
        </div>
        <div>
          <h1>Estimez votre r√©paration</h1>
          <p class="sub">S√©lectionnez l‚Äôappareil, choisissez le probl√®me, obtenez un prix indicatif.</p>
        </div>
      </div>
    </header>

    <div class="progress">
      <div id="p1" class="active"></div>
      <div id="p2"></div>
      <div id="p3"></div>
    </div>

    <main class="card" id="card">
      <!-- √âtape 1 -->
      <section id="step1">
        <h2>Quel appareil souhaitez-vous faire r√©parer ?</h2>
        <p class="lead">S√©lectionnez la <strong>marque</strong> puis votre <strong>mod√®le</strong>.</p>

        <div class="grid grid-3" style="margin-top:14px">
          <div>
            <label for="brand">Marque</label>
            <select id="brand">
              <option value="" selected hidden>Choisir une marque</option>
            </select>
          </div>
          <div>
            <label for="model-search">Mod√®le</label>
            <input type="text" id="model-search" placeholder="ex. iPhone 16 Pro Max, iPhone XR" />
            <div class="model-list" id="model-list"></div>
            <div id="model-hint" class="muted"></div>
            <div id="model-preview" class="preview" style="display:none">
              <img id="model-img" alt="aper√ßu iPhone"/>
              <div>
                <h3 id="model-title">iPhone</h3>
                <div class="small muted" id="model-sub">Aper√ßu du mod√®le s√©lectionn√©</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:16px">
          <span id="brand-model" class="muted"></span>
          <button id="btn1" class="btn" disabled>Continuer ‚Üí</button>
        </div>
      </section>

      <!-- √âtape 2 -->
      <section id="step2" style="display:none">
        <h2>Quel est le probl√®me ?</h2>
        <p class="lead">Vous pouvez s√©lectionner <strong>plusieurs</strong> √©l√©ments.</p>
        <div class="grid grid-4" id="issues" style="margin-top:12px"></div>

        <!-- Menus contextuels (√©cran + batterie) -->
        <div class="menus" id="tierMenus" style="display:none">
          <!-- √âCRAN -->
          <div class="menu-trigger" id="screenTierTrigger" style="display:none">
            <span>Gamme √©cran :</span>
            <span id="screenTierLabel" class="badge">Premium (OLED)</span>
            <span class="chev">‚ñæ</span>
            <div class="menu" id="screenMenu">
              <div class="item" data-value="compatible">
                <div>Compatible (LCD)</div>
                <div class="price" id="screenPriceCompatible">‚Äî</div>
              </div>
              <div class="item" data-value="premium">
                <div>Premium (OLED) <span class="badge">recommand√©</span></div>
                <div class="price" id="screenPricePremium">‚Äî</div>
              </div>
              <div class="item" data-value="original">
                <div>Original Apple</div>
                <div class="price" id="screenPriceOriginal">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- BATTERIE -->
          <div class="menu-trigger" id="batteryTierTrigger" style="display:none">
            <span>Gamme batterie :</span>
            <span id="batteryTierLabel" class="badge">Premium</span>
            <span class="chev">‚ñæ</span>
            <div class="menu" id="batteryMenu">
              <div class="item" data-value="compatible">
                <div>Compatible</div>
                <div class="price" id="batteryPriceCompatible">‚Äî</div>
              </div>
              <div class="item" data-value="premium">
                <div>Premium <span class="badge">historique : ‚ÄúR√©utilis√©(e)‚Äù</span></div>
                <div class="price" id="batteryPricePremium">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:16px">
          <button class="btn btn-outline" id="back2">‚Üê Retour</button>
          <button id="btn2" class="btn" disabled>Voir l‚Äôestimation ‚Üí</button>
        </div>
      </section>

      <!-- √âtape 3 -->
      <section id="step3" style="display:none">
        <h2>Votre estimation</h2>
        <p class="lead" id="estimate-sub">Prix indicatif</p>
        <div class="grid grid-estimation" style="margin-top:12px">
          <div class="card" style="margin:0; background:rgba(255,255,255,.03)">
            <div class="row">
              <div class="muted">Probl√®mes s√©lectionn√©s</div>
              <button class="btn btn-outline" id="editIssues">Modifier</button>
            </div>
            <ul class="resume-list" id="resume"></ul>
            <div class="total row">
              <div class="muted">Total indicatif</div>
              <div id="total" style="font-size:28px; font-weight:700">0‚Ç¨</div>
            </div>
            <p class="note">Estimation TTC √† titre indicatif. Prix susceptibles de varier selon diagnostic final, disponibilit√© des pi√®ces et √©tat g√©n√©ral de l‚Äôappareil.</p>
          </div>

          <!-- Bloc Prochaine √©tape -->
          <aside class="side-card">
            <h3>Prochaine √©tape</h3>

            <button class="cta cta-primary" id="cta-book">
              <span aria-hidden="true">üìÖ</span> Prendre RDV
            </button>

            <div style="height:10px"></div>

            <button class="cta cta-ghost" id="cta-quote">
              <span aria-hidden="true">üßæ</span> T√©l√©charger le devis (PDF)
            </button>

            <div style="height:10px"></div>

            <button class="cta cta-whatsapp" id="cta-whatsapp">
              <span aria-hidden="true">üí¨</span> Envoyer sur WhatsApp
            </button>

            <div class="note" style="margin-top:12px"><strong>Astuce :</strong> la plupart des r√©parations sont faites <em>sous 1h</em> en boutique.</div>
          </aside>
        </div>
        <div class="row" style="margin-top:16px">
          <button class="btn btn-outline" id="back3">‚Üê Retour</button>
          <button class="btn btn-outline" id="restart">Recommencer</button>
        </div>
      </section>
    </main>
  </div>

  <!-- jsPDF pour le devis PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ================== Donn√©es ==================
    const CATALOG = {
      Apple: [
        { id:'iphone-5', name:'iPhone 5' }, { id:'iphone-5c', name:'iPhone 5c' }, { id:'iphone-5s', name:'iPhone 5s' },
        { id:'iphone-6', name:'iPhone 6' }, { id:'iphone-6-plus', name:'iPhone 6 Plus' },
        { id:'iphone-6s', name:'iPhone 6s' }, { id:'iphone-6s-plus', name:'iPhone 6s Plus' },
        { id:'iphone-7', name:'iPhone 7' }, { id:'iphone-7-plus', name:'iPhone 7 Plus' },
        { id:'iphone-8', name:'iPhone 8' }, { id:'iphone-8-plus', name:'iPhone 8 Plus' },
        { id:'iphone-x', name:'iPhone X' }, { id:'iphone-xr', name:'iPhone XR' }, { id:'iphone-xs', name:'iPhone XS' }, { id:'iphone-xs-max', name:'iPhone XS Max' },
        { id:'iphone-11', name:'iPhone 11' }, { id:'iphone-11-pro', name:'iPhone 11 Pro' }, { id:'iphone-11-pro-max', name:'iPhone 11 Pro Max' },
        { id:'iphone-12-mini', name:'iPhone 12 mini' }, { id:'iphone-12', name:'iPhone 12' }, { id:'iphone-12-pro', name:'iPhone 12 Pro' }, { id:'iphone-12-pro-max', name:'iPhone 12 Pro Max' },
        { id:'iphone-13-mini', name:'iPhone 13 mini' }, { id:'iphone-13', name:'iPhone 13' }, { id:'iphone-13-pro', name:'iPhone 13 Pro' }, { id:'iphone-13-pro-max', name:'iPhone 13 Pro Max' },
        { id:'iphone-14', name:'iPhone 14' }, { id:'iphone-14-plus', name:'iPhone 14 Plus' }, { id:'iphone-14-pro', name:'iPhone 14 Pro' }, { id:'iphone-14-pro-max', name:'iPhone 14 Pro Max' },
        { id:'iphone-15', name:'iPhone 15' }, { id:'iphone-15-plus', name:'iPhone 15 Plus' }, { id:'iphone-15-pro', name:'iPhone 15 Pro' }, { id:'iphone-15-pro-max', name:'iPhone 15 Pro Max' },
        { id:'iphone-16', name:'iPhone 16' }, { id:'iphone-16-plus', name:'iPhone 16 Plus' }, { id:'iphone-16-pro', name:'iPhone 16 Pro' }, { id:'iphone-16-pro-max', name:'iPhone 16 Pro Max' }
      ],
      Samsung: [{ id:'galaxy-s24', name:'Galaxy S24' }, { id:'galaxy-s23', name:'Galaxy S23' }],
      Xiaomi: [{ id:'xiaomi-14', name:'Xiaomi 14' }]
    };

    const IMAGES = {
      'iphone-5':'/assets/iphone/iphone-5.jpg','iphone-5c':'/assets/iphone/iphone-5c.jpg','iphone-5s':'/assets/iphone/iphone-5s.jpg',
      'iphone-6':'/assets/iphone/iphone-6.jpg','iphone-6-plus':'/assets/iphone/iphone-6-plus.jpg','iphone-6s':'/assets/iphone/iphone-6s.jpg','iphone-6s-plus':'/assets/iphone/iphone-6s-plus.jpg',
      'iphone-7':'/assets/iphone/iphone-7.jpg','iphone-7-plus':'/assets/iphone/iphone-7-plus.jpg','iphone-8':'/assets/iphone/iphone-8.jpg','iphone-8-plus':'/assets/iphone/iphone-8-plus.jpg',
      'iphone-x':'/assets/iphone/iphone-x.jpg','iphone-xr':'/assets/iphone/iphone-xr.jpg','iphone-xs':'/assets/iphone/iphone-xs.jpg','iphone-xs-max':'/assets/iphone/iphone-xs-max.jpg',
      'iphone-11':'/assets/iphone/iphone-11.jpg','iphone-11-pro':'/assets/iphone/iphone-11-pro.jpg','iphone-11-pro-max':'/assets/iphone/iphone-11-pro-max.jpg',
      'iphone-12-mini':'/assets/iphone/iphone-12-mini.jpg','iphone-12':'/assets/iphone/iphone-12.jpg','iphone-12-pro':'/assets/iphone/iphone-12-pro.jpg','iphone-12-pro-max':'/assets/iphone/iphone-12-pro-max.jpg',
      'iphone-13-mini':'/assets/iphone/iphone-13-mini.jpg','iphone-13':'/assets/iphone/iphone-13.jpg','iphone-13-pro':'/assets/iphone/iphone-13-pro.jpg','iphone-13-pro-max':'/assets/iphone/iphone-13-pro-max.jpg',
      'iphone-14':'/assets/iphone/iphone-14.jpg','iphone-14-plus':'/assets/iphone/iphone-14-plus.jpg','iphone-14-pro':'/assets/iphone/iphone-14-pro.jpg','iphone-14-pro-max':'/assets/iphone/iphone-14-pro-max.jpg',
      'iphone-15':'/assets/iphone/iphone-15.jpg','iphone-15-plus':'/assets/iphone/iphone-15-plus.jpg','iphone-15-pro':'/assets/iphone/iphone-15-pro.jpg','iphone-15-pro-max':'/assets/iphone/iphone-15-pro-max.jpg',
      'iphone-16':'/assets/iphone/iphone-16.jpg','iphone-16-plus':'/assets/iphone/iphone-16-plus.jpg','iphone-16-pro':'/assets/iphone/iphone-16-pro.jpg','iphone-16-pro-max':'/assets/iphone/iphone-16-pro-max.jpg'
    };

    // ---- LISTE DES R√âPARATIONS ----
    const ISSUES = [
      // Affichage / coque
      { id:'screen', label:'√âcran cass√©', icon:'<path d="M3 7h18M3 17h18M7 3v18M17 3v18"/>' },
      { id:'back',   label:'Vitre Arri√®re', icon:'<rect x="5" y="2" width="14" height="20" rx="3"/><circle cx="12" cy="6" r="1"/>' },

      // Batterie / charge
      { id:'battery', label:'Batterie', icon:'<rect x="2" y="7" width="18" height="10" rx="2"/>' },
      { id:'charge',  label:'Connecteur de charge', icon:'<path d="M13 2L3 14h7l-1 8 10-12h-7z"/>' },

      // Audio
      { id:'speaker_top',    label:'Haut-parleur (haut)', icon:'<path d="M11 5l-6 4H2v6h3l6 4z"/>' },
      { id:'speaker_bottom', label:'Haut-parleur (bas)',  icon:'<path d="M11 5l-6 4H2v6h3l6 4z"/>' },
      { id:'mic_call',       label:'Micro (appel)',       icon:'<path d="M12 2v9a3 3 0 0 1-6 0V6"/>' },
      { id:'mic_video',      label:'Micro (vid√©o)',       icon:'<path d="M4 10v1a4 4 0 0 0 8 0v-1M12 2v4M8 18v4"/>' },
      { id:'vibrator',       label:'Vibreur',             icon:'<path d="M4 8l-2 2 2 2M20 8l2 2-2 2M8 5h8v14H8z"/>' },

      // Cam√©ras
      { id:'camera_front', label:'Cam√©ra frontale', icon:'<circle cx="12" cy="14" r="3"/>' },
      { id:'camera_back',  label:'Cam√©ra arri√®re',  icon:'<circle cx="12" cy="14" r="3"/>' },
      { id:'lens_back',    label:'Lentille cam√©ra arri√®re', icon:'<circle cx="12" cy="12" r="5"/>' },

      // Boutons / capteurs / flash
      { id:'power_button',  label:'Bouton Power',  icon:'<rect x="9" y="2" width="6" height="20" rx="3"/>' },
      { id:'home_button',   label:'Bouton Accueil',icon:'<circle cx="12" cy="12" r="5"/>' },
      { id:'volume_buttons',label:'Boutons de volume', icon:'<path d="M8 4v16M16 6v12"/>' },
      { id:'proximity',     label:'Capteur de proximit√©', icon:'<path d="M4 12h16M12 4v16"/>' },
      { id:'flash',         label:'Flash', icon:'<path d="M13 2L3 14h7l-1 8 10-12h-7z"/>' },

      // Logiciel / services
      { id:'reset',          label:'R√©initialisation',   icon:'<path d="M3 12a9 9 0 1 0 3-6"/>' },
      { id:'data_transfer',  label:'Transfert de donn√©es', icon:'<path d="M4 17l6-6 4 4 6-6"/>' },
      { id:'software_error', label:'Erreur logiciel',    icon:'<path d="M12 2l7 12H5L12 2z"/>' },
      { id:'deoxidation',    label:'D√©soxidation',       icon:'<path d="M12 2a6 6 0 1 0 0 12 6 6 0 0 1 0 12"/>' },
      { id:'motherboard',    label:'Carte m√®re (microsoudure)', icon:'<path d="M4 4h16v16H4zM8 8h8v8H8z"/>' },
      { id:'diag',           label:'Diagnostic',         icon:'<rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 12h2l2 3 2-6 2 3h2"/>' }
    ];

    // PRIX de d√©part (hors options sp√©cifiques)
    const PRICE_TABLE = {
      // affichage
      screen:         { Apple:199, Samsung:189, Xiaomi:149 },
      back:           { Apple:159, Samsung:149, Xiaomi:129 },

      // batterie / charge
      battery:        { Apple: 79, Samsung: 69, Xiaomi: 59 }, // valeur par d√©faut si pas de gamme sp√©cifique
      charge:         { Apple: 35, Samsung: 35, Xiaomi: 29 },

      // audio
      speaker_top:    { Apple: 30, Samsung: 29, Xiaomi: 25 },
      speaker_bottom: { Apple: 30, Samsung: 29, Xiaomi: 25 },
      mic_call:       { Apple: 30, Samsung: 29, Xiaomi: 25 },
      mic_video:      { Apple: 35, Samsung: 35, Xiaomi: 29 },
      vibrator:       { Apple: 20, Samsung: 19, Xiaomi: 19 },

      // cam√©ras
      camera_front:   { Apple: 30, Samsung: 29, Xiaomi: 25 },
      camera_back:    { Apple: 20, Samsung: 19, Xiaomi: 19 },
      lens_back:      { Apple: 15, Samsung: 15, Xiaomi: 15 },

      // boutons / capteurs / flash
      power_button:   { Apple: 40, Samsung: 39, Xiaomi: 35 },
      home_button:    { Apple: 15, Samsung: 15, Xiaomi: 15 },
      volume_buttons: { Apple: 40, Samsung: 39, Xiaomi: 35 },
      proximity:      { Apple: 30, Samsung: 29, Xiaomi: 25 },
      flash:          { Apple: 30, Samsung: 29, Xiaomi: 25 },

      // logiciel / services
      reset:          { Apple: 20, Samsung: 20, Xiaomi: 20 },
      data_transfer:  { Apple: 20, Samsung: 20, Xiaomi: 20 },
      software_error: { Apple: 30, Samsung: 29, Xiaomi: 25 },
      deoxidation:    { Apple: 20, Samsung: 20, Xiaomi: 20 },
      motherboard:    { Apple:699, Samsung:599, Xiaomi:499 },

      // diagnostic
      diag:           { Apple: 10, Samsung: 10, Xiaomi: 10 }
    };

    // Gammes √©cran iPhone X et +
    const IPHONE_SERIES_TIERS = {
      'X':{compatible:99,premium:149,original:249}, 'XR':{compatible:109,premium:159,original:259},
      'XS':{compatible:109,premium:159,original:259}, '11':{compatible:119,premium:169,original:279},
      '12':{compatible:139,premium:189,original:299}, '13':{compatible:149,premium:199,original:319},
      '14':{compatible:169,premium:219,original:339}, '15':{compatible:179,premium:229,original:359},
      '16':{compatible:189,premium:239,original:379}
    };

    // Gammes batterie iPhone (√† partir du 5 inclus)
    const IPHONE_BATTERY_TIERS = {
      compatible: 59,
      premium: 79  // Premium : pas de message "batterie non reconnue" ‚Äî historique : "R√©utilis√©(e)"
    };

    // Soci√©t√©
    const COMPANY = {
      name: "Pamko",
      phone: "+33 7 50 05 35 08",
      email: "contact@pamkocell.fr",
      website: "https://pamko.fr",
      address: "Centre Commercial - Paris / IDF",
      siret: "SIRET 952 740 389 00012",
      tva: "TVA FR70 952740389"
    };

    const LOGO_URL = "https://i.postimg.cc/Jnr0794g/PAMKO-LOGO-2026.png";
    const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1429389645874987069/bGM4TW6SPAnUX7sZwoqqRMoVwIr3rO-K8WRhKvujfN-UJB_jht2APaEgJ4q5iRDEyHGW";
    const WHATSAPP_NUMBER = "33750053508"; // intl sans "+"

    let state = { brand:'', model:'', issues:[], screenTier:'premium', batteryTier:'premium' };
    const $ = (s)=>document.querySelector(s);

    // ================== Helpers iPhone ==================
    function iphoneSeries(model){
      if(!model) return null;
      const m=model.match(/iPhone\s*(X|XR|XS|1[1-6]|10|12|13|14|15|16)(?:\s|$)/i);
      if(!m) return null; const s=m[1].toUpperCase(); return s==='10'?'X':s;
    }
    function isIphoneXPlus(){
      const s=iphoneSeries(state.model);
      return state.brand==='Apple' && s && ['X','XR','XS','11','12','13','14','15','16'].includes(s);
    }
    function getAppleScreenPrice(model,tier){
      const ser=iphoneSeries(model); if(!ser) return null;
      const t=IPHONE_SERIES_TIERS[ser]; return t?t[tier]:null;
    }
    function isAppleBatteryEligible(){
      return state.brand==='Apple' && !!state.model; // toutes g√©n√©rations iPhone
    }

    // ================== UI ==================
    function show(step){
      ['#step1','#step2','#step3'].forEach((id,i)=>$(id).style.display=i+1===step?'':'none');
      ['#p1','#p2','#p3'].forEach((id,i)=>$(id).classList.toggle('active',i+1<=step));
    }

    function renderBrands(){
      const sel = $('#brand');
      sel.innerHTML = '<option value="" selected hidden>Choisir une marque</option>' +
        Object.keys(CATALOG).map(b=>`<option value="${b}">${b}</option>`).join('');
      sel.value = state.brand || '';
    }

    function renderModels(searchTerm=null){
      const list=$('#model-list'), hint=$('#model-hint'); list.innerHTML='';
      if(!state.brand){ hint.textContent='Choisissez d‚Äôabord une marque.'; return; }
      const all = CATALOG[state.brand]||[];
      const s = (searchTerm!==null ? searchTerm : ($('#model-search')?.value||'')).trim().toLowerCase();
      const models = s ? all.filter(m=>m.name.toLowerCase().includes(s)) : all;
      if(!models.length){ hint.textContent=`Aucun mod√®le trouv√© pour ¬´ ${($('#model-search')?.value||'').trim()} ¬ª.`; return; }
      hint.textContent='';
      const frag=document.createDocumentFragment();
      models.forEach(m=>{
        const btn=document.createElement('button');
        btn.className='chip'+(state.model===m.name?' active':'');
        btn.type='button'; btn.textContent=m.name;
        btn.onclick=()=>{ state.model=m.name; $('#brand-model').textContent=state.brand+' ‚Ä¢ '+m.name; $('#btn1').disabled=false; renderPreview(m.id,m.name); renderModels(s); updateTierMenus(); };
        frag.appendChild(btn);
      });
      list.appendChild(frag);
    }

    function renderPreview(id,label){
      const url=IMAGES[id]; const img=$('#model-img'); const box=$('#model-preview');
      $('#model-title').textContent=label||'iPhone';
      $('#model-sub').textContent=url?'Aper√ßu du mod√®le s√©lectionn√©':'Aucune image d√©finie (ajoutez votre URL dans IMAGES)';
      if(url){ img.src=url; img.alt=label; } else { img.removeAttribute('src'); }
      box.style.display='grid';
    }

    function renderIssues(){
      const wrap=$('#issues'); wrap.innerHTML='';
      ISSUES.forEach(it=>{
        const active=state.issues.includes(it.id);
        let startPrice=(PRICE_TABLE[it.id]||{})[state.brand]||0;

        // ajuster l'affichage "d√®s" pour l'√©cran iPhone X+
        if(it.id==='screen' && state.brand==='Apple' && isIphoneXPlus()){
          const p=getAppleScreenPrice(state.model,'compatible'); if(p) startPrice=p;
        }
        // ajuster l'affichage "d√®s" pour batterie iPhone
        if(it.id==='battery' && isAppleBatteryEligible()){
          startPrice = IPHONE_BATTERY_TIERS.compatible;
        }

        const el=document.createElement('button');
        el.className='issue'+(active?' active':''); el.type='button';
        el.innerHTML=`<svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>${it.icon}</svg>
                      <div style='font-weight:600'>${it.label}</div>
                      <small>d√®s ${startPrice}‚Ç¨</small>
                      <span class='tick'>‚úî</span>`;
        el.onclick=()=>{ const i=state.issues.indexOf(it.id); if(i>-1) state.issues.splice(i,1); else state.issues.push(it.id);
                         renderIssues(); $('#btn2').disabled=state.issues.length===0; updateTierMenus(); };
        wrap.appendChild(el);
      });
    }

    // ===== Menus contextuels (√©cran + batterie) =====
    function euro(v){ return typeof v==='number' ? v.toFixed(0)+'‚Ç¨' : '‚Äî'; }

    function updateTierMenus(){
      const showAny = (state.issues.includes('screen') && isIphoneXPlus()) || (state.issues.includes('battery') && isAppleBatteryEligible());
      $('#tierMenus').style.display = showAny ? 'flex' : 'none';

      // SCREEN
      const showScreen = state.issues.includes('screen') && isIphoneXPlus();
      $('#screenTierTrigger').style.display = showScreen ? 'inline-flex' : 'none';
      if(showScreen){
        const pC = getAppleScreenPrice(state.model,'compatible');
        const pP = getAppleScreenPrice(state.model,'premium');
        const pO = getAppleScreenPrice(state.model,'original');
        $('#screenPriceCompatible').textContent = euro(pC);
        $('#screenPricePremium').textContent   = euro(pP);
        $('#screenPriceOriginal').textContent  = euro(pO);
        $('#screenTierLabel').textContent = state.screenTier==='compatible' ? 'Compatible (LCD)' :
                                            state.screenTier==='premium' ? 'Premium (OLED)' : 'Original Apple';
      }

      // BATTERY (Apple)
      const showBattery = state.issues.includes('battery') && isAppleBatteryEligible();
      $('#batteryTierTrigger').style.display = showBattery ? 'inline-flex' : 'none';
      if(showBattery){
        $('#batteryPriceCompatible').textContent = euro(IPHONE_BATTERY_TIERS.compatible);
        $('#batteryPricePremium').textContent   = euro(IPHONE_BATTERY_TIERS.premium);
        $('#batteryTierLabel').textContent = state.batteryTier==='compatible' ? 'Compatible' : 'Premium';
      }
    }

    // ouvrir/fermer au clic mobile
    function bindMenuToggle(triggerId, menuId){
      const trig = document.getElementById(triggerId);
      const menu = document.getElementById(menuId);
      if(!trig || !menu) return;
      trig.addEventListener('click', (e)=>{
        // √©viter d‚Äôouvrir si on clique un item (il g√®re sa propre action)
        if(e.target.classList.contains('item') || e.target.closest('.item')) return;
        menu.classList.toggle('open');
      });
      document.addEventListener('click', (e)=>{
        if(!trig.contains(e.target)) menu.classList.remove('open');
      });
    }

    function applyScreenTier(val){
      state.screenTier = val;
      updateTierMenus();
      // si d√©j√† sur √©tape 3, rafra√Æchir l‚Äôestimation
      if(document.querySelector('#step3').style.display!=='none'){ renderEstimate(); }
    }
    function applyBatteryTier(val){
      state.batteryTier = val;
      updateTierMenus();
      if(document.querySelector('#step3').style.display!=='none'){ renderEstimate(); }
    }

    // ===== Estimation =====
    function getIssueLine(issueId){
      let price=(PRICE_TABLE[issueId]||{})[state.brand]||0;
      let label=ISSUES.find(x=>x.id===issueId)?.label||issueId;

      // √âCRAN (gammes iPhone X+)
      if(issueId==='screen' && isIphoneXPlus()){
        const p=getAppleScreenPrice(state.model,state.screenTier);
        if(p){ price=p;
          const tierLabel= state.screenTier==='compatible'?'Compatible (LCD)':
                           state.screenTier==='premium'?'Premium (OLED)':'Original Apple';
          label+=` ‚Äî ${tierLabel}`;
        }
      }

      // BATTERIE iPhone (gammes)
      if(issueId==='battery' && isAppleBatteryEligible()){
        price = IPHONE_BATTERY_TIERS[state.batteryTier] ?? price;
        if(state.batteryTier==='compatible'){
          label += ' ‚Äî Compatible';
        }else{
          label += ' ‚Äî Premium (historique : "R√©utilis√©(e)")';
        }
      }

      return {label, price};
    }

    function buildEstimateLines(){
      const lines=[]; let total=0;
      state.issues.forEach(id=>{
        const {label,price}=getIssueLine(id);
        lines.push({label,price}); total+=price;
      });
      return {lines,total};
    }

    function renderEstimate(){
      $('#estimate-sub').textContent=`Prix indicatif pour ${state.brand} ‚Ä¢ ${state.model}`;
      const ul=$('#resume'); ul.innerHTML=''; let {lines,total}=buildEstimateLines();
      lines.forEach(({label,price})=>{
        const li=document.createElement('li'); li.className='resume-item';
        li.innerHTML=`<span>${label}</span><strong>${price}‚Ç¨</strong>`; ul.appendChild(li);
      });
      $('#total').textContent= total + '‚Ç¨';
    }

    // ================== Utils ==================
    async function fetchImageAsDataURL(url){
      try{
        const res = await fetch(url, {mode:'cors'});
        const blob = await res.blob();
        return await new Promise((resolve)=>{
          const reader=new FileReader(); reader.onload=()=>resolve(reader.result); reader.readAsDataURL(blob);
        });
      }catch(e){ return null; }
    }

    function newQuoteNumber(){
      const d=new Date();
      return `DEV-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`;
    }

    function buildWhatsAppMessage(){
      const {lines,total}=buildEstimateLines();
      const probs = lines.length ? lines.map(l=>`‚Ä¢ ${l.label} ‚Äî ${l.price}‚Ç¨`).join('\n') : '‚Ä¢ (aucun √©l√©ment s√©lectionn√©)';
      const screenTierText = state.issues.includes('screen') && isIphoneXPlus()
        ? `\nGamme √©cran : ${state.screenTier==='compatible'?'Compatible (LCD)':state.screenTier==='premium'?'Premium (OLED)':'Original Apple'}`
        : '';
      const batteryTierText = state.issues.includes('battery') && isAppleBatteryEligible()
        ? `\nGamme batterie : ${state.batteryTier==='compatible'?'Compatible':'Premium (historique : "R√©utilis√©(e)")'}`
        : '';
      return `Bonjour üëã
Je souhaite des infos pour une r√©paration.

Appareil : ${state.brand || '-'} ${state.model || ''}${screenTierText}${batteryTierText}

Probl√®mes s√©lectionn√©s :
${probs}

Total indicatif : ${total}‚Ç¨
Merci !`;
    }

    // ============== Devis PDF ==============
    async function createQuotePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const margin = 40; let y = margin;

      const { lines, total } = buildEstimateLines();
      const now = new Date();
      const dateStr = now.toLocaleDateString("fr-FR");
      const timeStr = now.toLocaleTimeString("fr-FR");
      const quoteNo = newQuoteNumber();

      // Logo
      const logoDataURL = await fetchImageAsDataURL(LOGO_URL);
      if(logoDataURL){
        try{ doc.addImage(logoDataURL, 'PNG', margin, y, 140, 40); }catch(e){}
      }

      // En-t√™te droite
      doc.setFont("helvetica","bold"); doc.setFontSize(22);
      doc.text("DEVIS", 555, y+10, {align:"right"});
      doc.setFont("helvetica","normal"); doc.setFontSize(11);
      doc.text(`N¬∞ : ${quoteNo}`, 555, y+30, {align:"right"});
      doc.text(`Date : ${dateStr} ${timeStr}`, 555, y+46, {align:"right"});

      // Soci√©t√©
      y += 60;
      doc.setFont("helvetica","bold"); doc.setFontSize(13);
      doc.text(COMPANY.name, margin, y); y+=16;
      doc.setFont("helvetica","normal"); doc.setFontSize(11);
      doc.text(COMPANY.address, margin, y); y+=14;
      doc.text(`T√©l : ${COMPANY.phone}`, margin, y); y+=14;
      doc.text(`Mail : ${COMPANY.email}`, margin, y); y+=14;
      doc.text(COMPANY.website, margin, y); y+=14;
      doc.text(COMPANY.siret, margin, y); y+=14;
      doc.text(COMPANY.tva,   margin, y); y+=22;

      // Client (optionnel)
      doc.setFont("helvetica","bold"); doc.setFontSize(13);
      doc.text("Client", margin, y); y+=16;
      doc.setFont("helvetica","normal"); doc.setFontSize(12);
      doc.text("(√† compl√©ter en boutique / par le client)", margin, y); y+=24;

      // Appareil
      doc.setFont("helvetica","bold"); doc.setFontSize(13);
      doc.text("Appareil", margin, y); y += 16;
      doc.setFont("helvetica","normal"); doc.setFontSize(12);
      const tierScreenLine = (state.issues.includes('screen') && isIphoneXPlus())
        ? ` ‚Ä¢ Gamme √©cran : ${state.screenTier==='compatible'?'Compatible (LCD)':state.screenTier==='premium'?'Premium (OLED)':'Original Apple'}`
        : "";
      const tierBatteryLine = (state.issues.includes('battery') && isAppleBatteryEligible())
        ? ` ‚Ä¢ Gamme batterie : ${state.batteryTier==='compatible'?'Compatible':'Premium (historique : "R√©utilis√©(e)")'}`
        : "";
      doc.text(`${state.brand || '-'} ${state.model || ''}${tierScreenLine}${tierBatteryLine}`, margin, y);
      y += 24;

      // Tableau
      doc.setFont("helvetica","bold"); doc.setFontSize(13);
      doc.text("D√©signation", margin, y);
      doc.text("Montant TTC", 555, y, {align:"right"});
      y+=10; doc.setDrawColor(200); doc.line(margin, y, 555, y); y+=14;

      doc.setFont("helvetica","normal"); doc.setFontSize(12);
      if(!lines.length){ doc.text("Aucun √©l√©ment s√©lectionn√©", margin, y); y+=18; }
      else{
        lines.forEach(({label,price})=>{
          const split = doc.splitTextToSize(label, 400);
          doc.text(split, margin, y);
          doc.text(`${price} ‚Ç¨`, 555, y, { align:"right" });
          const h = 14 * (Array.isArray(split) ? split.length : 1);
          y += h + 6; if(y > 760){ doc.addPage(); y = margin; }
        });
      }

      // Total
      y += 8; doc.setDrawColor(200); doc.line(margin, y, 555, y); y += 22;
      doc.setFont("helvetica","bold"); doc.setFontSize(14);
      doc.text("Total TTC", margin, y);
      doc.text(`${total} ‚Ç¨`, 555, y, { align: "right" }); y += 26;

      // Mentions
      doc.setFont("helvetica","normal"); doc.setFontSize(10);
      const note = "Devis TTC √† titre indicatif. Prix susceptibles de varier selon diagnostic final, disponibilit√© des pi√®ces et √©tat g√©n√©ral de l‚Äôappareil. Ce devis peut √™tre transmis √† votre assurance.";
      doc.text(doc.splitTextToSize(note, 515), margin, y);

      const safeModel = (state.model || "Appareil").replace(/[^a-z0-9\- ]/ig,'').replace(/\s+/g,'-');
      const filename = `${quoteNo}-Pamko-${safeModel}.pdf`;
      doc.save(filename);

      return { quoteNo, dateStr, timeStr, total, lines };
    }

    // ============== Logs Discord ==============
    function logToDiscord(payloadText){
      try{
        const body = new URLSearchParams({ content: payloadText }).toString();
        fetch(DISCORD_WEBHOOK, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
      }catch(e){ /* silencieux */ }
    }

    function buildDiscordMessage(meta){
      const {lines,total} = buildEstimateLines();
      const probs = lines.length ? lines.map(l=>`‚Ä¢ ${l.label} ‚Äî ${l.price}‚Ç¨`).join('\n') : '‚Ä¢ (aucun √©l√©ment s√©lectionn√©)';
      const screenTierText = state.issues.includes('screen') && isIphoneXPlus()
        ? `\nGamme √©cran : ${state.screenTier==='compatible'?'Compatible (LCD)':state.screenTier==='premium'?'Premium (OLED)':'Original Apple'}`
        : '';
      const batteryTierText = state.issues.includes('battery') && isAppleBatteryEligible()
        ? `\nGamme batterie : ${state.batteryTier==='compatible'?'Compatible':'Premium (historique : "R√©utilis√©(e)")'}`
        : '';
      const head = meta ? `\nDevis: ${meta.quoteNo} ‚Äî ${meta.dateStr} ${meta.timeStr}` : '';
      return `üßæ **Pamko ‚Äì Nouveau devis**
Appareil : ${state.brand || '-'} ${state.model || ''}${screenTierText}${batteryTierText}
${head}

D√©tails:
${probs}

Total TTC: ${total}‚Ç¨`;
    }

    // ============== Events ==============
    $('#brand').onchange=(e)=>{ state.brand=e.target.value; state.model=''; state.issues=[]; state.screenTier='premium'; state.batteryTier='premium';
      $('#model-search').value=''; $('#brand-model').textContent=''; $('#model-preview').style.display='none';
      renderModels(''); renderIssues(); $('#btn1').disabled=true; $('#btn2').disabled=true; updateTierMenus();
    };

    (()=>{ const input=$('#model-search'); if(input){ input.addEventListener('input',e=>renderModels(e.target.value)); input.addEventListener('change',e=>renderModels(e.target.value)); }})();

    $('#btn1').onclick=()=>show(2);
    $('#back2').onclick=()=>show(1);
    $('#btn2').onclick=()=>{ renderEstimate(); show(3); };
    $('#editIssues').onclick=()=>show(2);
    $('#back3').onclick=()=>show(2);
    $('#restart').onclick=()=>{ state={brand:'',model:'',issues:[],screenTier:'premium',batteryTier:'premium'};
      renderBrands(); $('#model-search').value=''; renderModels(); renderIssues();
      $('#brand-model').textContent=''; $('#model-preview').style.display='none';
      $('#btn1').disabled=true; $('#btn2').disabled=true; updateTierMenus(); show(1);
    };

    // Menus toggles (click)
    bindMenuToggle('screenTierTrigger','screenMenu');
    bindMenuToggle('batteryTierTrigger','batteryMenu');

    // S√©lection menus
    document.getElementById('screenMenu')?.addEventListener('click',(e)=>{
      const it=e.target.closest('.item'); if(!it) return;
      applyScreenTier(it.dataset.value); document.getElementById('screenMenu').classList.remove('open');
    });
    document.getElementById('batteryMenu')?.addEventListener('click',(e)=>{
      const it=e.target.closest('.item'); if(!it) return;
      applyBatteryTier(it.dataset.value); document.getElementById('batteryMenu').classList.remove('open');
    });

    // RDV
    document.getElementById('cta-book')?.addEventListener('click', ()=>{ window.location.href='/prendre-rdv'; });

    // Devis (PDF + log Discord)
    document.getElementById('cta-quote')?.addEventListener('click', async ()=>{
      const meta = await createQuotePDF();
      const message = buildDiscordMessage(meta);
      logToDiscord(message);
    });

    // WhatsApp (r√©cap estimation)
    document.getElementById('cta-whatsapp')?.addEventListener('click', ()=>{
      const text = encodeURIComponent(buildWhatsAppMessage());
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${text}`, '_blank');
    });

    // Init
    renderBrands(); renderModels(); renderIssues(); updateTierMenus(); show(1);
  </script>
</body>
</html>
